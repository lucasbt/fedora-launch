#!/usr/bin/env bash
#
# fedoralaunch - Modular and intelligent post-install for Fedora Workstation
#

set -euo pipefail

export SCRIPT_DIR="$HOME/.local/share/fedoralaunch"

source "$SCRIPT_DIR/lib/utils.sh"

LOCK_FILE="/tmp/fedoralaunch.lock"

# ---
# ## Global Variables
# ---
FEDORALAUNCH_VERSION=$(cat "${SCRIPT_DIR}/version")
MODULES_DIR="${SCRIPT_DIR}/modules"

# ---
# ## Functions
# ---

acquire_lock() {
    exec 9>"$LOCK_FILE" || exit 1
    if ! flock -n 9; then
        log_error "Another fedoralaunch process is already running."
        exit 1
    fi
}

release_lock() {
    flock -u 9 || true
    rm -f "$LOCK_FILE"
}

show_help() {
    echo "Fedora Launch v${FEDORALAUNCH_VERSION} â€” Post-install setup for Fedora 43+ made easy!"
    echo "...by the community, for the community!"
    echo
    echo "Usage: fedoralaunch [command]"
    echo
    echo "Commands:"
    echo "  list                         List available modules"
    echo "  status                       View status"
    echo "  install [all|<module>]       Install a new module or run an existing one"
    echo "  config                       Edit configuration"
    echo "  self-update                  Update fedoralaunch"
    echo "  self-uninstall               Uninstall fedoralaunch"
    echo "  doctor [--json]              Check the system for common problems"
    echo "                               --json outputs machine-readable JSON"
    echo "  search <term>                Search for a module by name or description"
    echo "  log                          View the log file"
    echo "  version                      View the version of fedoralaunch"
    echo "  help                         Show this help message"
    echo
}

list_modules() {
    print_header "Available Modules"
    
    find "${MODULES_DIR}" -maxdepth 1 -type f -name "*.sh" | while read -r module; do
        priority=$(grep -m 1 "^# Priority:" "$module" | cut -d: -f2- | xargs)
        echo "$priority:$module"
    done | sort -n | while IFS=: read -r priority module; do
        module_name=$(basename "$module" .sh)
        description=$(grep -m 1 "^# Description:" "$module" | cut -d: -f2- | xargs)
        echo -e "  [${priority}] ${COLOR_GREEN}${module_name}${COLOR_RESET} - ${description}"
    done
}

run_module() {
    local module_name="$1"
    local module_file="${MODULES_DIR}/${module_name}.sh"

    if [ ! -f "$module_file" ]; then
        log_error "Module '${module_name}' not found."
        exit 1
    fi

    local module_func
    module_func="${module_name//-/_}_main"

    log_info "Running module: ${module_name}"
    source "$module_file"
    if ! declare -f "$module_func" >/dev/null; then
        log_error "Module '${module_name}' does not define ${module_func}()"
        exit 1
    fi    
    "$module_func"
    log_info "Module '${module_name}' executed."
}

install_all_modules() {
    print_header "Installing All Modules"
    
    find "${MODULES_DIR}" -maxdepth 1 -type f -name "*.sh" | while read -r module; do
        priority=$(grep -m 1 "^# Priority:" "$module" | cut -d: -f2- | xargs)
        echo "$priority:$module"
    done | sort -n | while IFS=: read -r priority module; do
        module_name=$(basename "$module" .sh)
        run_module "$module_name" || log_warning "Module $module_name failed"
    done
    
    echo
    log_info "Please reboot your system for all changes to take effect\n"
    
    log_info "All modules installed."
}

edit_config() {
    if [ -n "${EDITOR}" ]; then
        "$EDITOR" "$CONFIG_FILE"
    else
        nano "$CONFIG_FILE"
    fi
}

self_update() {
    print_header "Self-updating fedoralaunch"
    backup_file "$CONFIG_FILE"
    git -C "$SCRIPT_DIR" fetch --all
    git -C "$SCRIPT_DIR" reset --hard origin/main
    git -C "$SCRIPT_DIR" pull origin main
    restore_file "$CONFIG_FILE"
    print_footer "fedoralaunch updated successfully."
}

uninstall() {
    print_header "Uninstalling fedoralaunch"
    log_info "Removing fedoralaunch files..."
    rm -rf "$HOME/.local/share/fedoralaunch"
    rm -f "$HOME/.local/bin/fedoralaunch"
    print_footer "fedoralaunch uninstalled successfully."
}

show_status() {
    print_header "fedoralaunch Status"
    log_info "Version: ${FEDORALAUNCH_VERSION}"
    log_info "Installation directory: ${SCRIPT_DIR}"
    log_info "Configuration file: ${CONFIG_FILE}"
    log_info "Log file: ${LOG_FILE}"
}

run_version() {
    print_header "fedoralaunch Version"
    log_info "Version: ${FEDORALAUNCH_VERSION}"
}

run_log() {
    less "${LOG_FILE}"
}

run_search() {
    local search_term="$1"
    print_header "Search results for: ${search_term}"
    
    find "${MODULES_DIR}" -maxdepth 1 -type f -name "*.sh" | while read -r module; do
        priority=$(grep -m 1 "^# Priority:" "$module" | cut -d: -f2- | xargs)
        module_name=$(basename "$module" .sh)
        description=$(grep -m 1 "^# Description:" "$module" | cut -d: -f2- | xargs)
        
        if [[ "$module_name" == *"$search_term"* ]] || [[ "$description" == *"$search_term"* ]]; then
            echo -e "  [${priority}] ${COLOR_GREEN}${module_name}${COLOR_RESET} - ${description}"
        fi
    done
}

run_doctor() {
    print_header "System Doctor"

    log_section "Checking Dependencies"
    missing_deps=()
    for dep in git jq; do
        if ! command -v "$dep" &>/dev/null; then
            missing_deps+=("$dep")
        fi
    done

    if [ "${#missing_deps[@]}" -gt 0 ]; then
        log_warning "Missing dependencies detected: ${missing_deps[*]}"
        log_info "Installing missing dependencies..."
        sudo dnf install -y "${missing_deps[@]}"
        log_success "Dependencies installed."
    else
        log_success "All required dependencies are installed."
    fi

    log_section "Checking Fedora Version"
    local current_version=$(rpm -E %fedora)
    local latest_version=$(curl -sL "https://fedoraproject.org/releases.json" | jq -r '.[0].version')
    if [ "$current_version" -lt "$latest_version" ]; then
        log_warning "Your system is running an outdated version of Fedora."
        log_info "Consider upgrading to the latest version for the best experience."
    else
        log_success "Your system is running the latest version of Fedora."
    fi


    log_section "Checking Disk Space"
    local free_space=$(df -h / | awk 'NR==2 {print $4}')
    log_info "Free disk space: ${free_space}"

    log_section "Checking Memory"
    local free_mem=$(free -h | awk 'NR==2 {print $7}')
    log_info "Free memory: ${free_mem}"

    log_section "Checking for Broken Packages"
    local broken_packages=$(sudo dnf check | grep broken || true)
    if [ -n "$broken_packages" ]; then
        log_warning "Your system has broken packages."
        log_info "Run 'sudo dnf check' for more information."
    else
        log_success "No broken packages found."
    fi

    print_footer "System check complete."
}

run_doctor_json() {
    local current_version latest_version fedora_status
    local free_disk free_mem broken_packages

    current_version=$(rpm -E %fedora)

    if command -v jq &>/dev/null; then
        latest_version=$(curl -sL "https://fedoraproject.org/releases.json" | jq -r '.[0].version')
        if [ "$current_version" -lt "$latest_version" ]; then
            fedora_status="outdated"
        else
            fedora_status="latest"
        fi
    else
        fedora_status="unknown"
    fi

    free_disk=$(df -h / | awk 'NR==2 {print $4}')
    free_mem=$(free -h | awk 'NR==2 {print $7}')

    broken_packages=$(sudo dnf check 2>/dev/null | grep broken || true)

    jq -n \
        --arg fedora_version "$current_version" \
        --arg fedora_status "$fedora_status" \
        --arg free_disk "$free_disk" \
        --arg free_mem "$free_mem" \
        --arg broken_packages "$broken_packages" \
        '{
            fedora: {
                version: $fedora_version,
                status: $fedora_status
            },
            system: {
                free_disk: $free_disk,
                free_memory: $free_mem
            },
            packages: {
                broken: ($broken_packages != "")
            }
        }'
}


# ---
# ## Main Execution
# ---

main() {
    acquire_lock
    trap release_lock EXIT

    if [ ! -f /etc/fedora-release ]; then
        log_error "This script is intended for Fedora Workstation only."
        exit 1
    fi

    init_logging
    load_config

    : "${CONFIG_FILE:?CONFIG_FILE not set}"
    : "${LOG_FILE:?LOG_FILE not set}"

    if [ $# -eq 0 ]; then
        show_banner
        show_help
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        list)
            list_modules
            ;;
        status)
            show_status
            ;;
        install)
            show_banner
            if [ "$1" = "all" ]; then
                install_all_modules
                log_warning "\nATTENTION!!! CONSIDER RESTARTING YOUR SYSTEM TO PROPERLY APPLY THE CHANGES!"
            elif [ -n "$1" ]; then
                run_module "$1"
            else
                log_error "Please specify a module to install or 'all'.\n"
                show_help
            fi
            ;;
        config)
            edit_config
            ;;
        self-update)
            show_banner
            self_update
            ;;
        self-uninstall)
            uninstall
            ;;
        doctor)
            if [ "$1" = "--json" ]; then
                run_doctor_json
            else
                run_doctor
            fi
            ;;
        search)
            if [ -n "$1" ]; then
                run_search "$1"
            else
                log_error "Please specify a search term.\n"
                show_help
            fi
            ;;
        log)
            run_log
            ;;
        version)
            run_version
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "Unknown command: $command"
            show_help
            exit 1
            ;;
    esac
}

if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    main "$@"
fi
